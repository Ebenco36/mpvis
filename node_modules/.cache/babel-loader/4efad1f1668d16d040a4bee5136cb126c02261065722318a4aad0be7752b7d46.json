{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { array, isArray, isObject, isString } from 'vega-util';\nimport { isBinned } from '../../../bin';\nimport { getMainRangeChannel, isXorY, THETA, RADIUS } from '../../../channel';\nimport { defaultTitle, getFieldDef, getFormatMixins, hasConditionalFieldDef, isFieldDef, isTypedFieldDef, vgField } from '../../../channeldef';\nimport { forEach } from '../../../encoding';\nimport { entries } from '../../../util';\nimport { isSignalRef } from '../../../vega.schema';\nimport { getMarkPropOrConfig } from '../../common';\nimport { binFormatExpression, formatSignalRef } from '../../format';\nimport { wrapCondition } from './conditional';\nimport { textRef } from './text';\nexport function tooltip(model, opt = {}) {\n  const {\n    encoding,\n    markDef,\n    config,\n    stack\n  } = model;\n  const channelDef = encoding.tooltip;\n  if (isArray(channelDef)) {\n    return {\n      tooltip: tooltipRefForEncoding({\n        tooltip: channelDef\n      }, stack, config, opt)\n    };\n  } else {\n    const datum = opt.reactiveGeom ? 'datum.datum' : 'datum';\n    return wrapCondition(model, channelDef, 'tooltip', cDef => {\n      // use valueRef based on channelDef first\n      const tooltipRefFromChannelDef = textRef(cDef, config, datum);\n      if (tooltipRefFromChannelDef) {\n        return tooltipRefFromChannelDef;\n      }\n      if (cDef === null) {\n        // Allow using encoding.tooltip = null to disable tooltip\n        return undefined;\n      }\n      let markTooltip = getMarkPropOrConfig('tooltip', markDef, config);\n      if (markTooltip === true) {\n        markTooltip = {\n          content: 'encoding'\n        };\n      }\n      if (isString(markTooltip)) {\n        return {\n          value: markTooltip\n        };\n      } else if (isObject(markTooltip)) {\n        // `tooltip` is `{fields: 'encodings' | 'fields'}`\n        if (isSignalRef(markTooltip)) {\n          return markTooltip;\n        } else if (markTooltip.content === 'encoding') {\n          return tooltipRefForEncoding(encoding, stack, config, opt);\n        } else {\n          return {\n            signal: datum\n          };\n        }\n      }\n      return undefined;\n    });\n  }\n}\nexport function tooltipData(encoding, stack, config, {\n  reactiveGeom\n} = {}) {\n  const formatConfig = {\n    ...config,\n    ...config.tooltipFormat\n  };\n  const toSkip = {};\n  const expr = reactiveGeom ? 'datum.datum' : 'datum';\n  const tuples = [];\n  function add(fDef, channel) {\n    const mainChannel = getMainRangeChannel(channel);\n    const fieldDef = isTypedFieldDef(fDef) ? fDef : {\n      ...fDef,\n      type: encoding[mainChannel].type // for secondary field def, copy type from main channel\n    };\n\n    const title = fieldDef.title || defaultTitle(fieldDef, formatConfig);\n    const key = array(title).join(', ').replaceAll(/\"/g, '\\\\\"');\n    let value;\n    if (isXorY(channel)) {\n      const channel2 = channel === 'x' ? 'x2' : 'y2';\n      const fieldDef2 = getFieldDef(encoding[channel2]);\n      if (isBinned(fieldDef.bin) && fieldDef2) {\n        const startField = vgField(fieldDef, {\n          expr\n        });\n        const endField = vgField(fieldDef2, {\n          expr\n        });\n        const {\n          format,\n          formatType\n        } = getFormatMixins(fieldDef);\n        value = binFormatExpression(startField, endField, format, formatType, formatConfig);\n        toSkip[channel2] = true;\n      }\n    }\n    if ((isXorY(channel) || channel === THETA || channel === RADIUS) && stack && stack.fieldChannel === channel && stack.offset === 'normalize') {\n      const {\n        format,\n        formatType\n      } = getFormatMixins(fieldDef);\n      value = formatSignalRef({\n        fieldOrDatumDef: fieldDef,\n        format,\n        formatType,\n        expr,\n        config: formatConfig,\n        normalizeStack: true\n      }).signal;\n    }\n    value ?? (value = textRef(fieldDef, formatConfig, expr).signal);\n    tuples.push({\n      channel,\n      key,\n      value\n    });\n  }\n  forEach(encoding, (channelDef, channel) => {\n    if (isFieldDef(channelDef)) {\n      add(channelDef, channel);\n    } else if (hasConditionalFieldDef(channelDef)) {\n      add(channelDef.condition, channel);\n    }\n  });\n  const out = {};\n  for (const {\n    channel,\n    key,\n    value\n  } of tuples) {\n    if (!toSkip[channel] && !out[key]) {\n      out[key] = value;\n    }\n  }\n  return out;\n}\nexport function tooltipRefForEncoding(encoding, stack, config, {\n  reactiveGeom\n} = {}) {\n  const data = tooltipData(encoding, stack, config, {\n    reactiveGeom\n  });\n  const keyValues = entries(data).map(([key, value]) => `\"${key}\": ${value}`);\n  return keyValues.length > 0 ? {\n    signal: `{${keyValues.join(', ')}}`\n  } : undefined;\n}","map":{"version":3,"names":["array","isArray","isObject","isString","isBinned","getMainRangeChannel","isXorY","THETA","RADIUS","defaultTitle","getFieldDef","getFormatMixins","hasConditionalFieldDef","isFieldDef","isTypedFieldDef","vgField","forEach","entries","isSignalRef","getMarkPropOrConfig","binFormatExpression","formatSignalRef","wrapCondition","textRef","tooltip","model","opt","encoding","markDef","config","stack","channelDef","tooltipRefForEncoding","datum","reactiveGeom","cDef","tooltipRefFromChannelDef","undefined","markTooltip","content","value","signal","tooltipData","formatConfig","tooltipFormat","toSkip","expr","tuples","add","fDef","channel","mainChannel","fieldDef","type","title","key","join","replaceAll","channel2","fieldDef2","bin","startField","endField","format","formatType","fieldChannel","offset","fieldOrDatumDef","normalizeStack","push","condition","out","data","keyValues","map","length"],"sources":["../../../../../src/compile/mark/encode/tooltip.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}