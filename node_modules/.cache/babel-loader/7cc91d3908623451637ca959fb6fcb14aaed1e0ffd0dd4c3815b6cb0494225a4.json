{"ast":null,"code":"import { isBinned, isBinning } from '../../bin';\nimport { isFieldDef, isNumericDataDef, isUnbinnedQuantitativeFieldOrDatumDef, isTypedFieldDef } from '../../channeldef';\nimport { isAggregate } from '../../encoding';\nimport { replaceExprRef } from '../../expr';\nimport * as log from '../../log';\nimport { AREA, BAR, BAR_CORNER_RADIUS_INDEX as BAR_CORNER_RADIUS_END_INDEX, CIRCLE, IMAGE, LINE, POINT, RECT, RULE, SQUARE, TEXT, TICK } from '../../mark';\nimport { QUANTITATIVE, TEMPORAL } from '../../type';\nimport { contains, getFirstDefined } from '../../util';\nimport { getMarkConfig, getMarkPropOrConfig } from '../common';\nexport function initMarkdef(originalMarkDef, encoding, config) {\n  // FIXME: markDef expects that exprRefs are replaced recursively but replaceExprRef only replaces the top level\n  const markDef = replaceExprRef(originalMarkDef);\n  // set orient, which can be overridden by rules as sometimes the specified orient is invalid.\n  const specifiedOrient = getMarkPropOrConfig('orient', markDef, config);\n  markDef.orient = orient(markDef.type, encoding, specifiedOrient);\n  if (specifiedOrient !== undefined && specifiedOrient !== markDef.orient) {\n    log.warn(log.message.orientOverridden(markDef.orient, specifiedOrient));\n  }\n  if (markDef.type === 'bar' && markDef.orient) {\n    const cornerRadiusEnd = getMarkPropOrConfig('cornerRadiusEnd', markDef, config);\n    if (cornerRadiusEnd !== undefined) {\n      const newProps = markDef.orient === 'horizontal' && encoding.x2 || markDef.orient === 'vertical' && encoding.y2 ? ['cornerRadius'] : BAR_CORNER_RADIUS_END_INDEX[markDef.orient];\n      for (const newProp of newProps) {\n        markDef[newProp] = cornerRadiusEnd;\n      }\n      if (markDef.cornerRadiusEnd !== undefined) {\n        delete markDef.cornerRadiusEnd; // no need to keep the original cap cornerRadius\n      }\n    }\n  }\n  // set opacity and filled if not specified in mark config\n  const specifiedOpacity = getMarkPropOrConfig('opacity', markDef, config);\n  if (specifiedOpacity === undefined) {\n    markDef.opacity = opacity(markDef.type, encoding);\n  }\n  // set cursor, which should be pointer if href channel is present unless otherwise specified\n  const specifiedCursor = getMarkPropOrConfig('cursor', markDef, config);\n  if (specifiedCursor === undefined) {\n    markDef.cursor = cursor(markDef, encoding, config);\n  }\n  return markDef;\n}\nfunction cursor(markDef, encoding, config) {\n  if (encoding.href || markDef.href || getMarkPropOrConfig('href', markDef, config)) {\n    return 'pointer';\n  }\n  return markDef.cursor;\n}\nfunction opacity(mark, encoding) {\n  if (contains([POINT, TICK, CIRCLE, SQUARE], mark)) {\n    // point-based marks\n    if (!isAggregate(encoding)) {\n      return 0.7;\n    }\n  }\n  return undefined;\n}\nexport function defaultFilled(markDef, config, {\n  graticule\n}) {\n  if (graticule) {\n    return false;\n  }\n  const filledConfig = getMarkConfig('filled', markDef, config);\n  const mark = markDef.type;\n  return getFirstDefined(filledConfig, mark !== POINT && mark !== LINE && mark !== RULE);\n}\nfunction orient(mark, encoding, specifiedOrient) {\n  switch (mark) {\n    case POINT:\n    case CIRCLE:\n    case SQUARE:\n    case TEXT:\n    case RECT:\n    case IMAGE:\n      // orient is meaningless for these marks.\n      return undefined;\n  }\n  const {\n    x,\n    y,\n    x2,\n    y2\n  } = encoding;\n  switch (mark) {\n    case BAR:\n      if (isFieldDef(x) && (isBinned(x.bin) || isFieldDef(y) && y.aggregate && !x.aggregate)) {\n        return 'vertical';\n      }\n      if (isFieldDef(y) && (isBinned(y.bin) || isFieldDef(x) && x.aggregate && !y.aggregate)) {\n        return 'horizontal';\n      }\n      if (y2 || x2) {\n        // Ranged bar does not always have clear orientation, so we allow overriding\n        if (specifiedOrient) {\n          return specifiedOrient;\n        }\n        // If y is range and x is non-range, non-bin Q\n        if (!x2) {\n          if (isFieldDef(x) && x.type === QUANTITATIVE && !isBinning(x.bin) || isNumericDataDef(x)) {\n            if (isFieldDef(y) && isBinned(y.bin)) {\n              return 'horizontal';\n            }\n          }\n          return 'vertical';\n        }\n        // If x is range and y is non-range, non-bin Q\n        if (!y2) {\n          if (isFieldDef(y) && y.type === QUANTITATIVE && !isBinning(y.bin) || isNumericDataDef(y)) {\n            if (isFieldDef(x) && isBinned(x.bin)) {\n              return 'vertical';\n            }\n          }\n          return 'horizontal';\n        }\n      }\n    // falls through\n    case RULE:\n      // return undefined for line segment rule and bar with both axis ranged\n      // we have to ignore the case that the data are already binned\n      if (x2 && !(isFieldDef(x) && isBinned(x.bin)) && y2 && !(isFieldDef(y) && isBinned(y.bin))) {\n        return undefined;\n      }\n    // falls through\n    case AREA:\n      // If there are range for both x and y, y (vertical) has higher precedence.\n      if (y2) {\n        if (isFieldDef(y) && isBinned(y.bin)) {\n          return 'horizontal';\n        } else {\n          return 'vertical';\n        }\n      } else if (x2) {\n        if (isFieldDef(x) && isBinned(x.bin)) {\n          return 'vertical';\n        } else {\n          return 'horizontal';\n        }\n      } else if (mark === RULE) {\n        if (x && !y) {\n          return 'vertical';\n        } else if (y && !x) {\n          return 'horizontal';\n        }\n      }\n    // falls through\n    case LINE:\n    case TICK:\n      {\n        const xIsMeasure = isUnbinnedQuantitativeFieldOrDatumDef(x);\n        const yIsMeasure = isUnbinnedQuantitativeFieldOrDatumDef(y);\n        if (specifiedOrient) {\n          return specifiedOrient;\n        } else if (xIsMeasure && !yIsMeasure) {\n          // Tick is opposite to bar, line, area\n          return mark !== 'tick' ? 'horizontal' : 'vertical';\n        } else if (!xIsMeasure && yIsMeasure) {\n          // Tick is opposite to bar, line, area\n          return mark !== 'tick' ? 'vertical' : 'horizontal';\n        } else if (xIsMeasure && yIsMeasure) {\n          return 'vertical';\n        } else {\n          const xIsTemporal = isTypedFieldDef(x) && x.type === TEMPORAL;\n          const yIsTemporal = isTypedFieldDef(y) && y.type === TEMPORAL;\n          // x: T, y: N --> vertical tick\n          if (xIsTemporal && !yIsTemporal) {\n            return 'vertical';\n          } else if (!xIsTemporal && yIsTemporal) {\n            return 'horizontal';\n          }\n        }\n        return undefined;\n      }\n  }\n  return 'vertical';\n}","map":{"version":3,"names":["isBinned","isBinning","isFieldDef","isNumericDataDef","isUnbinnedQuantitativeFieldOrDatumDef","isTypedFieldDef","isAggregate","replaceExprRef","log","AREA","BAR","BAR_CORNER_RADIUS_INDEX","BAR_CORNER_RADIUS_END_INDEX","CIRCLE","IMAGE","LINE","POINT","RECT","RULE","SQUARE","TEXT","TICK","QUANTITATIVE","TEMPORAL","contains","getFirstDefined","getMarkConfig","getMarkPropOrConfig","initMarkdef","originalMarkDef","encoding","config","markDef","specifiedOrient","orient","type","undefined","warn","message","orientOverridden","cornerRadiusEnd","newProps","x2","y2","newProp","specifiedOpacity","opacity","specifiedCursor","cursor","href","mark","defaultFilled","graticule","filledConfig","x","y","bin","aggregate","xIsMeasure","yIsMeasure","xIsTemporal","yIsTemporal"],"sources":["../../../../src/compile/mark/init.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}