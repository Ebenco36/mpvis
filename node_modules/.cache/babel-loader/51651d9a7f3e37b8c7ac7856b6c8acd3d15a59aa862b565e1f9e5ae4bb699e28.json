{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { isArray, isBoolean, isString } from 'vega-util';\nimport { isContinuousFieldOrDatumDef, isFieldDef, isFieldOrDatumDefForTimeFormat } from '../channeldef';\nimport { fieldDefs } from '../encoding';\nimport * as log from '../log';\nimport { isMarkDef } from '../mark';\nimport { getFirstDefined, hash, unique } from '../util';\nimport { isSignalRef } from '../vega.schema';\nimport { toStringFieldDef } from './../channeldef';\nexport function filterTooltipWithAggregatedField(oldEncoding) {\n  const {\n    tooltip,\n    ...filteredEncoding\n  } = oldEncoding;\n  if (!tooltip) {\n    return {\n      filteredEncoding\n    };\n  }\n  let customTooltipWithAggregatedField;\n  let customTooltipWithoutAggregatedField;\n  if (isArray(tooltip)) {\n    for (const t of tooltip) {\n      if (t.aggregate) {\n        if (!customTooltipWithAggregatedField) {\n          customTooltipWithAggregatedField = [];\n        }\n        customTooltipWithAggregatedField.push(t);\n      } else {\n        if (!customTooltipWithoutAggregatedField) {\n          customTooltipWithoutAggregatedField = [];\n        }\n        customTooltipWithoutAggregatedField.push(t);\n      }\n    }\n    if (customTooltipWithAggregatedField) {\n      filteredEncoding.tooltip = customTooltipWithAggregatedField;\n    }\n  } else {\n    if (tooltip['aggregate']) {\n      filteredEncoding.tooltip = tooltip;\n    } else {\n      customTooltipWithoutAggregatedField = tooltip;\n    }\n  }\n  if (isArray(customTooltipWithoutAggregatedField) && customTooltipWithoutAggregatedField.length === 1) {\n    customTooltipWithoutAggregatedField = customTooltipWithoutAggregatedField[0];\n  }\n  return {\n    customTooltipWithoutAggregatedField,\n    filteredEncoding\n  };\n}\nexport function getCompositeMarkTooltip(tooltipSummary, continuousAxisChannelDef, encodingWithoutContinuousAxis, withFieldName = true) {\n  if ('tooltip' in encodingWithoutContinuousAxis) {\n    return {\n      tooltip: encodingWithoutContinuousAxis.tooltip\n    };\n  }\n  const fiveSummaryTooltip = tooltipSummary.map(({\n    fieldPrefix,\n    titlePrefix\n  }) => {\n    const mainTitle = withFieldName ? ` of ${getTitle(continuousAxisChannelDef)}` : '';\n    return {\n      field: fieldPrefix + continuousAxisChannelDef.field,\n      type: continuousAxisChannelDef.type,\n      title: isSignalRef(titlePrefix) ? {\n        signal: `${titlePrefix}\"${escape(mainTitle)}\"`\n      } : titlePrefix + mainTitle\n    };\n  });\n  const tooltipFieldDefs = fieldDefs(encodingWithoutContinuousAxis).map(toStringFieldDef);\n  return {\n    tooltip: [...fiveSummaryTooltip,\n    // need to cast because TextFieldDef supports fewer types of bin\n    ...unique(tooltipFieldDefs, hash)]\n  };\n}\nexport function getTitle(continuousAxisChannelDef) {\n  const {\n    title,\n    field\n  } = continuousAxisChannelDef;\n  return getFirstDefined(title, field);\n}\nexport function makeCompositeAggregatePartFactory(compositeMarkDef, continuousAxis, continuousAxisChannelDef, sharedEncoding, compositeMarkConfig) {\n  const {\n    scale,\n    axis\n  } = continuousAxisChannelDef;\n  return ({\n    partName,\n    mark,\n    positionPrefix,\n    endPositionPrefix = undefined,\n    extraEncoding = {}\n  }) => {\n    const title = getTitle(continuousAxisChannelDef);\n    return partLayerMixins(compositeMarkDef, partName, compositeMarkConfig, {\n      mark,\n      encoding: {\n        [continuousAxis]: {\n          field: `${positionPrefix}_${continuousAxisChannelDef.field}`,\n          type: continuousAxisChannelDef.type,\n          ...(title !== undefined ? {\n            title\n          } : {}),\n          ...(scale !== undefined ? {\n            scale\n          } : {}),\n          ...(axis !== undefined ? {\n            axis\n          } : {})\n        },\n        ...(isString(endPositionPrefix) ? {\n          [`${continuousAxis}2`]: {\n            field: `${endPositionPrefix}_${continuousAxisChannelDef.field}`\n          }\n        } : {}),\n        ...sharedEncoding,\n        ...extraEncoding\n      }\n    });\n  };\n}\nexport function partLayerMixins(markDef, part, compositeMarkConfig, partBaseSpec) {\n  const {\n    clip,\n    color,\n    opacity\n  } = markDef;\n  const mark = markDef.type;\n  if (markDef[part] || markDef[part] === undefined && compositeMarkConfig[part]) {\n    return [{\n      ...partBaseSpec,\n      mark: {\n        ...compositeMarkConfig[part],\n        ...(clip ? {\n          clip\n        } : {}),\n        ...(color ? {\n          color\n        } : {}),\n        ...(opacity ? {\n          opacity\n        } : {}),\n        ...(isMarkDef(partBaseSpec.mark) ? partBaseSpec.mark : {\n          type: partBaseSpec.mark\n        }),\n        style: `${mark}-${String(part)}`,\n        ...(isBoolean(markDef[part]) ? {} : markDef[part])\n      }\n    }];\n  }\n  return [];\n}\nexport function compositeMarkContinuousAxis(spec, orient, compositeMark) {\n  const {\n    encoding\n  } = spec;\n  const continuousAxis = orient === 'vertical' ? 'y' : 'x';\n  const continuousAxisChannelDef = encoding[continuousAxis]; // Safe to cast because if x is not continuous fielddef, the orient would not be horizontal.\n  const continuousAxisChannelDef2 = encoding[`${continuousAxis}2`];\n  const continuousAxisChannelDefError = encoding[`${continuousAxis}Error`];\n  const continuousAxisChannelDefError2 = encoding[`${continuousAxis}Error2`];\n  return {\n    continuousAxisChannelDef: filterAggregateFromChannelDef(continuousAxisChannelDef, compositeMark),\n    continuousAxisChannelDef2: filterAggregateFromChannelDef(continuousAxisChannelDef2, compositeMark),\n    continuousAxisChannelDefError: filterAggregateFromChannelDef(continuousAxisChannelDefError, compositeMark),\n    continuousAxisChannelDefError2: filterAggregateFromChannelDef(continuousAxisChannelDefError2, compositeMark),\n    continuousAxis\n  };\n}\nfunction filterAggregateFromChannelDef(continuousAxisChannelDef, compositeMark) {\n  if (continuousAxisChannelDef?.aggregate) {\n    const {\n      aggregate,\n      ...continuousAxisWithoutAggregate\n    } = continuousAxisChannelDef;\n    if (aggregate !== compositeMark) {\n      log.warn(log.message.errorBarContinuousAxisHasCustomizedAggregate(aggregate, compositeMark));\n    }\n    return continuousAxisWithoutAggregate;\n  } else {\n    return continuousAxisChannelDef;\n  }\n}\nexport function compositeMarkOrient(spec, compositeMark) {\n  const {\n    mark,\n    encoding\n  } = spec;\n  const {\n    x,\n    y\n  } = encoding;\n  if (isMarkDef(mark) && mark.orient) {\n    return mark.orient;\n  }\n  if (isContinuousFieldOrDatumDef(x)) {\n    // x is continuous\n    if (isContinuousFieldOrDatumDef(y)) {\n      // both x and y are continuous\n      const xAggregate = isFieldDef(x) && x.aggregate;\n      const yAggregate = isFieldDef(y) && y.aggregate;\n      if (!xAggregate && yAggregate === compositeMark) {\n        return 'vertical';\n      } else if (!yAggregate && xAggregate === compositeMark) {\n        return 'horizontal';\n      } else if (xAggregate === compositeMark && yAggregate === compositeMark) {\n        throw new Error('Both x and y cannot have aggregate');\n      } else {\n        if (isFieldOrDatumDefForTimeFormat(y) && !isFieldOrDatumDefForTimeFormat(x)) {\n          // y is temporal but x is not\n          return 'horizontal';\n        }\n        // default orientation for two continuous\n        return 'vertical';\n      }\n    }\n    return 'horizontal';\n  } else if (isContinuousFieldOrDatumDef(y)) {\n    // y is continuous but x is not\n    return 'vertical';\n  } else {\n    // Neither x nor y is continuous.\n    throw new Error(`Need a valid continuous axis for ${compositeMark}s`);\n  }\n}","map":{"version":3,"names":["isArray","isBoolean","isString","isContinuousFieldOrDatumDef","isFieldDef","isFieldOrDatumDefForTimeFormat","fieldDefs","log","isMarkDef","getFirstDefined","hash","unique","isSignalRef","toStringFieldDef","filterTooltipWithAggregatedField","oldEncoding","tooltip","filteredEncoding","customTooltipWithAggregatedField","customTooltipWithoutAggregatedField","t","aggregate","push","length","getCompositeMarkTooltip","tooltipSummary","continuousAxisChannelDef","encodingWithoutContinuousAxis","withFieldName","fiveSummaryTooltip","map","fieldPrefix","titlePrefix","mainTitle","getTitle","field","type","title","signal","escape","tooltipFieldDefs","makeCompositeAggregatePartFactory","compositeMarkDef","continuousAxis","sharedEncoding","compositeMarkConfig","scale","axis","partName","mark","positionPrefix","endPositionPrefix","undefined","extraEncoding","partLayerMixins","encoding","markDef","part","partBaseSpec","clip","color","opacity","style","String","compositeMarkContinuousAxis","spec","orient","compositeMark","continuousAxisChannelDef2","continuousAxisChannelDefError","continuousAxisChannelDefError2","filterAggregateFromChannelDef","continuousAxisWithoutAggregate","warn","message","errorBarContinuousAxisHasCustomizedAggregate","compositeMarkOrient","x","y","xAggregate","yAggregate","Error"],"sources":["../../../src/compositemark/common.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}