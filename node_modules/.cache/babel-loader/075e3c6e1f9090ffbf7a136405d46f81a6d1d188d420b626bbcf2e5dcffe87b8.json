{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { array, isArray, stringValue } from 'vega-util';\nimport { vgField } from '../channeldef';\nimport { isExprRef } from '../expr';\nimport { isText } from '../title';\nimport { deepEqual, getFirstDefined } from '../util';\nimport { isSignalRef } from '../vega.schema';\nexport const BIN_RANGE_DELIMITER = ' \\u2013 ';\nexport function signalOrValueRefWithCondition(val) {\n  const condition = isArray(val.condition) ? val.condition.map(conditionalSignalRefOrValue) : conditionalSignalRefOrValue(val.condition);\n  return {\n    ...signalRefOrValue(val),\n    condition\n  };\n}\nexport function signalRefOrValue(value) {\n  if (isExprRef(value)) {\n    const {\n      expr,\n      ...rest\n    } = value;\n    return {\n      signal: expr,\n      ...rest\n    };\n  }\n  return value;\n}\nexport function conditionalSignalRefOrValue(value) {\n  if (isExprRef(value)) {\n    const {\n      expr,\n      ...rest\n    } = value;\n    return {\n      signal: expr,\n      ...rest\n    };\n  }\n  return value;\n}\nexport function signalOrValueRef(value) {\n  if (isExprRef(value)) {\n    const {\n      expr,\n      ...rest\n    } = value;\n    return {\n      signal: expr,\n      ...rest\n    };\n  }\n  if (isSignalRef(value)) {\n    return value;\n  }\n  return value !== undefined ? {\n    value\n  } : undefined;\n}\nexport function exprFromSignalRefOrValue(ref) {\n  if (isSignalRef(ref)) {\n    return ref.signal;\n  }\n  return stringValue(ref);\n}\nexport function exprFromValueRefOrSignalRef(ref) {\n  if (isSignalRef(ref)) {\n    return ref.signal;\n  }\n  return stringValue(ref.value);\n}\nexport function signalOrStringValue(v) {\n  if (isSignalRef(v)) {\n    return v.signal;\n  }\n  return v == null ? null : stringValue(v);\n}\nexport function applyMarkConfig(e, model, propsList) {\n  for (const property of propsList) {\n    const value = getMarkConfig(property, model.markDef, model.config);\n    if (value !== undefined) {\n      e[property] = signalOrValueRef(value);\n    }\n  }\n  return e;\n}\nexport function getStyles(mark) {\n  return [].concat(mark.type, mark.style ?? []);\n}\nexport function getMarkPropOrConfig(channel, mark, config, opt = {}) {\n  const {\n    vgChannel,\n    ignoreVgConfig\n  } = opt;\n  if (vgChannel && mark[vgChannel] !== undefined) {\n    return mark[vgChannel];\n  } else if (mark[channel] !== undefined) {\n    return mark[channel];\n  } else if (ignoreVgConfig && (!vgChannel || vgChannel === channel)) {\n    return undefined;\n  }\n  return getMarkConfig(channel, mark, config, opt);\n}\n/**\n * Return property value from style or mark specific config property if exists.\n * Otherwise, return general mark specific config.\n */\nexport function getMarkConfig(channel, mark, config, {\n  vgChannel\n} = {}) {\n  return getFirstDefined(\n  // style config has highest precedence\n  vgChannel ? getMarkStyleConfig(channel, mark, config.style) : undefined, getMarkStyleConfig(channel, mark, config.style),\n  // then mark-specific config\n  vgChannel ? config[mark.type][vgChannel] : undefined, config[mark.type][channel],\n  // Need to cast because MarkDef doesn't perfectly match with AnyMarkConfig, but if the type isn't available, we'll get nothing here, which is fine\n  // If there is vgChannel, skip vl channel.\n  // For example, vl size for text is vg fontSize, but config.mark.size is only for point size.\n  vgChannel ? config.mark[vgChannel] : config.mark[channel] // Need to cast for the same reason as above\n  );\n}\n\nexport function getMarkStyleConfig(prop, mark, styleConfigIndex) {\n  return getStyleConfig(prop, getStyles(mark), styleConfigIndex);\n}\nexport function getStyleConfig(p, styles, styleConfigIndex) {\n  styles = array(styles);\n  let value;\n  for (const style of styles) {\n    const styleConfig = styleConfigIndex[style];\n    if (styleConfig && styleConfig[p] !== undefined) {\n      value = styleConfig[p];\n    }\n  }\n  return value;\n}\n/**\n * Return Vega sort parameters (tuple of field and order).\n */\nexport function sortParams(orderDef, fieldRefOption) {\n  return array(orderDef).reduce((s, orderChannelDef) => {\n    s.field.push(vgField(orderChannelDef, fieldRefOption));\n    s.order.push(orderChannelDef.sort ?? 'ascending');\n    return s;\n  }, {\n    field: [],\n    order: []\n  });\n}\nexport function mergeTitleFieldDefs(f1, f2) {\n  const merged = [...f1];\n  f2.forEach(fdToMerge => {\n    for (const fieldDef1 of merged) {\n      // If already exists, no need to append to merged array\n      if (deepEqual(fieldDef1, fdToMerge)) {\n        return;\n      }\n    }\n    merged.push(fdToMerge);\n  });\n  return merged;\n}\nexport function mergeTitle(title1, title2) {\n  if (deepEqual(title1, title2) || !title2) {\n    // if titles are the same or title2 is falsy\n    return title1;\n  } else if (!title1) {\n    // if title1 is falsy\n    return title2;\n  } else {\n    return [...array(title1), ...array(title2)].join(', ');\n  }\n}\nexport function mergeTitleComponent(v1, v2) {\n  const v1Val = v1.value;\n  const v2Val = v2.value;\n  if (v1Val == null || v2Val === null) {\n    return {\n      explicit: v1.explicit,\n      value: null\n    };\n  } else if ((isText(v1Val) || isSignalRef(v1Val)) && (isText(v2Val) || isSignalRef(v2Val))) {\n    return {\n      explicit: v1.explicit,\n      value: mergeTitle(v1Val, v2Val)\n    };\n  } else if (isText(v1Val) || isSignalRef(v1Val)) {\n    return {\n      explicit: v1.explicit,\n      value: v1Val\n    };\n  } else if (isText(v2Val) || isSignalRef(v2Val)) {\n    return {\n      explicit: v1.explicit,\n      value: v2Val\n    };\n  } else if (!isText(v1Val) && !isSignalRef(v1Val) && !isText(v2Val) && !isSignalRef(v2Val)) {\n    return {\n      explicit: v1.explicit,\n      value: mergeTitleFieldDefs(v1Val, v2Val)\n    };\n  }\n  /* istanbul ignore next: Condition should not happen -- only for warning in development. */\n  throw new Error('It should never reach here');\n}","map":{"version":3,"names":["array","isArray","stringValue","vgField","isExprRef","isText","deepEqual","getFirstDefined","isSignalRef","BIN_RANGE_DELIMITER","signalOrValueRefWithCondition","val","condition","map","conditionalSignalRefOrValue","signalRefOrValue","value","expr","rest","signal","signalOrValueRef","undefined","exprFromSignalRefOrValue","ref","exprFromValueRefOrSignalRef","signalOrStringValue","v","applyMarkConfig","e","model","propsList","property","getMarkConfig","markDef","config","getStyles","mark","concat","type","style","getMarkPropOrConfig","channel","opt","vgChannel","ignoreVgConfig","getMarkStyleConfig","prop","styleConfigIndex","getStyleConfig","p","styles","styleConfig","sortParams","orderDef","fieldRefOption","reduce","s","orderChannelDef","field","push","order","sort","mergeTitleFieldDefs","f1","f2","merged","forEach","fdToMerge","fieldDef1","mergeTitle","title1","title2","join","mergeTitleComponent","v1","v2","v1Val","v2Val","explicit","Error"],"sources":["../../../src/compile/common.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}